@using HabitTrack_UI.Models.ErrorModels
@using HabitTrack_UI.Services
@implements IDisposable

@inject ErrorService ErrorService

@if (_visible)
{
    <div class="error-toast">
        @_message
    </div>
}

@code {
    private bool _visible;
    private string? _message;
    private bool _disposed;

    protected override void OnInitialized()
    {
        ErrorService.OnError += HandleError;
    }

    private async void HandleError(AppError error)
    {
        if (_disposed) return;

        _message = error.Message;
        _visible = true;

        await InvokeAsync(StateHasChanged);

        _ = HideLater();
    }

    private async Task HideLater()
    {
        await Task.Delay(4000);

        if (_disposed) return;

        _visible = false;
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _disposed = true;
        ErrorService.OnError -= HandleError;
    }
}