@page "/login"
@* @layout AuthLayout; *@
@attribute [AllowAnonymous]

@using System.ComponentModel.DataAnnotations
@using HabitTrack_UI.Models;
@using HabitTrack_UI.Models.ErrorModels
@using HabitTrack_UI.Services
@using HabitTrack_UI.Services.AppErrorService
@using HabitTrack_UI.Services.Auth
@using HabitTracker.Application.DTOs
@using Microsoft.AspNetCore.Authorization

@inject AuthService AuthService
@inject NavigationManager Nav

<h3>Hello!</h3>
<p>Login to get started</p>

<EditForm Model="Model" OnValidSubmit="HandleLogin">
    <DataAnnotationsValidator />
    <div>
        <label>Email:</label>
        <InputText @bind-Value="Model.Email" placeholder="your email" />
        <ValidationMessage For="@(() => Model.Email)" />
    </div>

    <div>
        <label>Password:</label>
        <InputText @bind-Value="Model.Password" type="password" placeholder="password" />
        <ValidationMessage For="@(() => Model.Password)" />
    </div>

    @if (LoginErrorMessage is not null)
    {
        <p class="error">@LoginErrorMessage</p>
    }

    <button type="submit" disabled="@IsSubmitting">
        @(IsSubmitting ? "Loggin in..." : "Loggin")
    </button>

    <div>
        <NavLink href="/register">I don't have an account</NavLink>
    </div>
    <p>Forgot password</p>
</EditForm>

@code {
    private LoginModel Model = new LoginModel();
    private bool IsSubmitting;
    private string? LoginErrorMessage;

    private async Task HandleLogin()
    {
        LoginErrorMessage = null;
        IsSubmitting = true;

        try
        {
            var request = new LoginRequest
            {
                Email = Model.Email,
                Password = Model.Password
            };

            await AuthService.LoginAsync(request);

            Nav.NavigateTo("/");
        }
        catch (AppException ex)
        {
            if (ex.Error.Type == ErrorType.Unauthorized)
            {
                LoginErrorMessage = "Invalid credentials";
            }
        }
        finally
        {
            IsSubmitting = false;
            Model.Password = string.Empty;
        }
    }
}
