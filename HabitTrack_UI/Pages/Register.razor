@page "/register";
@layout AuthLayout;
@attribute [AllowAnonymous]

@using HabitTrack_UI.Models;
@using HabitTrack_UI.Services
@using HabitTrack_UI.Services.AppErrorService
@using HabitTrack_UI.Services.Auth
@using HabitTracker.Application.DTOs
@using Microsoft.AspNetCore.Authorization

@inject AuthService AuthService
@inject NavigationManager Nav

<div class="card shadow-sm p-4" style="width: 100%; max-width: 420px;">

    <div class="mb-4 text-center">
        <h3 class="fw-bold">Hello!</h3>
        <p class="text-muted mb-0">Sign up to get started</p>
    </div>

    <EditForm Model="Model" OnValidSubmit="HandleRegister">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label class="form-label">Email</label>
            <InputText class="form-control"
                        @bind-Value="Model.Email"
                        placeholder="you@example.com" />
            <ValidationMessage For="@(() => Model.Email)" class="text-danger small" />
        </div>

        <div class="mb-3">
            <label class="form-label">Password</label>
            <InputText class="form-control"
                        type="password"
                        @bind-Value="Model.Password"
                        placeholder="Password" />
            <ValidationMessage For="@(() => Model.Password)" class="text-danger small" />
        </div>

        <div class="mb-3">
            <label class="form-label">Confirm password</label>
            <InputText class="form-control"
                        type="password"
                        @bind-Value="Model.ConfirmPassword"
                        placeholder="Confirm password" />
            <ValidationMessage For="@(() => Model.ConfirmPassword)" class="text-danger small" />
        </div>

        @if (ErrorMessage is not null)
        {
            <div class="alert alert-danger py-2">
                @ErrorMessage
            </div>
        }

        <button type="submit"
                class="btn btn-primary w-100"
                disabled="@IsSubmitting">
            @(IsSubmitting ? "Registering..." : "Register")
        </button>

        <div class="text-center mt-3">
            <NavLink href="/login">
                I already have an account
            </NavLink>
        </div>

    </EditForm>

</div>


@code {
    private readonly RegisterModel Model = new RegisterModel();
    private bool IsSubmitting = false;
    private string? ErrorMessage;

    private async Task HandleRegister()
    {
        IsSubmitting = true;

        try
        {
            var request = new RegisterRequest
            {
                UserName = Model.Email,
                Email = Model.Email,
                Password = Model.Password
            };

            await AuthService.RegisterAsync(request);

            Nav.NavigateTo("/login");
        }
        catch (AppException ex)
        {
            ErrorMessage = ex?.Error?.Message ?? "Something went wrong";
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}
